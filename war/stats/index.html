<html>
  <head>
    <title>GGP Federated Statistics Server</title>
    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Droid+Sans:bold">
    <link rel="stylesheet" type="text/css" href="/apollo.css" />
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
    <script type='text/javascript' src='//www.ggp.org/scripts/Analytics.js'></script>
  </head>
  <body>
    <script type='text/javascript' src='//www.ggp.org/scripts/common/ResourceLoader.js'></script>
    <script type='text/javascript' src='//www.ggp.org/scripts/common/UserInterface.js'></script>
    <script type="text/javascript" src="//www.ggp.org/scripts/external/jquery.flot.js"></script>
    <script language="javascript" type="text/javascript" src="//people.iola.dk/olau/flot/jquery.flot.stack.js"></script> 
<style>
th {
  font-variant: small-caps;
  font-size: 20px;
}
th.top_th {
  background-image: -webkit-gradient(
    linear,
    left bottom,
    left top,
    color-stop(0.24, #CCC),
    color-stop(0.81, #AAA)
  );
  background-image: -moz-linear-gradient(
    center bottom,
    rgb(230,230,230) 24%,
    rgb(184,184,184) 81%
  );
}
td.name {
  font-weight:bold;
  width: 200px;
}
</style>

    <div id='header'></div>
    <br>
    <center>
      <table width=100%><tr><td width=3%></td><td valign=top width=150px>
        <center>
        <table id="leaderboard" border=1px bgcolor=#CCC cellpadding=5px>
          <tr><th class="top_th" colspan=6>Merged Federated Leaderboard</th></tr>
          <tr><th>Player</th><th>Matches</th><th>Avg Score</th><th>NetScore</th><th>EloRank</th><th>AgonSkill</th></tr>
        </table>
        <br>
        <div id="status_div" width=150px></div><br>
        <div id="push_viz" style="width:600px;height:300px;"></div>
        <div id="matches_viz" style="width:600px;height:300px;"></div>
        </center>
      </td><td valign=top width=150px>
        <center>
        <table id="server_stats" border=1px bgcolor=#CCC cellpadding=5px>
          <th class="top_th" colspan=2>Stats Server Statistics</th>
        </table>
        </center>
      </td><td width=3%></td></tr></table>
    </center>

    <script type='text/javascript'>
      var statsJSON = ResourceLoader.load_json('/statistics/all/overall');
      
      function getOptionalMapValue(playerName, statsData, mapName) {
        if (mapName in statsData && playerName in statsData[mapName]) {
          return statsData[mapName][playerName];
        }
        return "";
      }

      cleanFloat = function (x) { return Math.round(x*100)/100; };
      var sortablePairs = [];
      for (var pName in statsJSON.leaderboard) {
        var theBoardStats = JSON.parse(statsJSON.leaderboard[pName]);        
        var thePlayerRank = getOptionalMapValue(pName, statsJSON, "playerRank");
        var theNetScore = getOptionalMapValue(pName, statsJSON, "netScore");
        var theEloRank = getOptionalMapValue(pName, statsJSON, "eloRank");
        var theAgonSkill = getOptionalMapValue(pName, statsJSON, "agonSkill");
        var sortKey = cleanFloat(theAgonSkill);
        sortablePairs.push([sortKey, pName, 1*theBoardStats[1], 1*theBoardStats[0], theNetScore, theEloRank, theAgonSkill]);
      }
      sortablePairs.sort(function(a,b){return(b[0]-a[0]);});
      leadersHTML = "";
      for (var i = 0; i < sortablePairs.length; i++) {
        var playerName = sortablePairs[i][1];
        leadersHTML += '<tr><td class="name">'+playerName+'</td>';
        for (var j = 2; j < sortablePairs[i].length; j++) {
          leadersHTML += '<td>'+cleanFloat(sortablePairs[i][j])+'</td>';
        }
        leadersHTML += '</tr>';
        // TODO: add back information about the decayed leaderboard
        //'<td>'+cleanFloat(statsJSON.decayedLeaderboard[sortablePairs[i][1]])+'</td></tr>'; 
      }
      document.getElementById('leaderboard').children[0].innerHTML += leadersHTML;

      delete statsJSON.leaderboard;
      delete statsJSON.decayedLeaderboard;
      delete statsJSON.playerRank;
      delete statsJSON.netScore;
      delete statsJSON.eloRank;
      delete statsJSON.agonSkill;
      delete statsJSON.agonDifficulty;
      delete statsJSON.matchesStartedChart;

      var varNameMapping = {
        "matches": "Total Matches",
        "matchesFinished": "Matches Finished",
        "matchesAbandoned": "Matches Abandoned",
        "matchesStatErrors": "Matches Unreadable",
        "computeTime": "Time Updating Stats",
        "matchesPerDayMedian": "Median Matches/Day",
        "matchesInPastHour": "Matches in Past Hour",
        "matchesInPastDay": "Matches in Past Day",
        "computedAt": "Stats Last Updated",
        "matchesAverageMoves": "Average Moves/Match",
        "matchesAveragePlayers": "Average Players/Match",
        "playerRankError": "PlayerRank Error",
        "statsVersion": "Stats Version",
        "playerRankDelta": "PlayerRank Delta",
        "computeRAM": "Memory Updating Stats"
      };

      varsHTML = "";
      for (var varName in statsJSON) {
        var varProperName = varName;
        if (varNameMapping[varName]) varProperName = varNameMapping[varName];
        var varValue = cleanFloat(statsJSON[varName]);        
        if (varName == "computedAt") varValue = Math.round((new Date() - 1*statsJSON[varName])/1000) + 's ago';
        if (varName == "computeRAM") varValue = cleanFloat(1*statsJSON[varName]/(1024*1024)) + ' MB';  
        varsHTML += '<tr><td class="name">'+varProperName+'</td><td>'+varValue+'</td></tr>';
      }
      document.getElementById('server_stats').children[0].innerHTML += varsHTML;

      var serverState = ResourceLoader.load_json('/data/serverState/overall');
      var stateHTML = 'Most recent match key sent via PuSH: <br><tt>' + serverState.mostRecentUpdate + '</tt><br>';
      stateHTML += 'That match key was sent at ' + UserInterface.renderDateTime(new Date(serverState.mostRecentUpdateDate)) + '.<br>';
      document.getElementById('status_div').innerHTML = stateHTML;

      var timesAgo = [];
      serverState.recentUpdateTimes.reverse();
      for (var i = 0; i < serverState.recentUpdateTimes.length; i++) {
        timesAgo.push([i, (new Date() - new Date(serverState.recentUpdateTimes[i])) / 60000.0 ]);        
      }
      $.plot($("#push_viz"), [ {data: timesAgo, label: "PuSH Update Freshness", lines: { show: true, fill: true }} ], {legend: { position: 'nw' }});

      generateTimeSeries = function (z) {
        var q = [];
        for (var x in z) {
          if (z[x] > 0) {
            q.push([1*x, z[x]]);
          }
        }
        q.sort();
        return q;
      }
      generateTimeSeriesFromData = function (z) {
        return generateTimeSeries(ResourceLoader.load_json('/statistics/'+z+'/overall').matchesStartedChart);
      }
      
      qApollo = generateTimeSeriesFromData('90bd08a7df7b8113a45f1e537c1853c3974006b2');      
      //qArtemis = generateTimeSeriesFromData('5bc94f8e793772e8585a444f2fc95d2ac087fed0');
      qDresden = generateTimeSeriesFromData('f69721b2f73839e513eed991e96824f1af218ac1');      
      qUnsigned = generateTimeSeriesFromData('unsigned');
      //qSimpleSim = generateTimeSeriesFromData('0ca7065b86d7646166d86233f9e23ac47d8320d4');

      $.plot($("#matches_viz"), [{data: qDresden, label: "Dresden Matches over Time", color: 'blue'},                                 
                                 {data: qUnsigned, label: "Unsigned Matches over Time", color: 'gray'},
                                 {data: qApollo, label: "Apollo Matches over Time", color: 'green'},
                                 //{data: qArtemis, label: "Artemis Matches over Time", color: 'yellow'},
                                 //{data: qSimpleSim, label: "SimpleSim Matches over Time", color: 'red'},                                 
                                 ],
             {xaxes: [{mode:'time'}],
              lines: {show: true, fill: true},             
              series: {stack: true},
              legend: {position: 'nw'}});
    </script>
  </body>  
</html>